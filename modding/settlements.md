# Settlements

- [API](https://apidoc.bannerlord.com/v/1.1.0/class_tale_worlds_1_1_campaign_system_1_1_settlements_1_1_settlement.html){target=_blank}
- [Calradia World Map Castles](https://docs.google.com/spreadsheets/d/1aXAwpqAKICjhjr4PGIeXeV1A5GcKsLHDAnNMjX6K1Qs/edit){target=_blank}
- [Calradia World Map Villages](https://docs.google.com/spreadsheets/d/1VqSQAa1xDS3MwrWku55P_roDQS_HWXdLdgzOMhz_O3g/edit){target=_blank}
- [Town Scenes](https://docs.google.com/presentation/d/1GMQqoVQnrmqpTq8xDSfySev2kmBMKiFxNVGRdOazRQs/edit#slide=id.p){target=_blank} by d&h
- [Town Scenes](https://docs.google.com/presentation/d/1-Wc2IgQPuarkUlFCDsqYNYwqJHyOxlihWFuQOXSG_AQ/edit#slide=id.g2b3b6874ee5_0_45){target=_blank} by d&h

## Current Settlement we are at

``` cs
Settlement.CurrentSettlement
```

## The settlement hero is at currently

    Hero.CurrentSettlement

## Notables

    Settlement.Notables
    if (town.Notables.Contains(notable)) return true;

## Type of Settlement

    bool value
    .IsTown
    .IsCastle
    .IsVillage
    .IsHideout
    .IsFortification (Town OR Castle)

## Granary/food

How much food in the granary:

``` cs
Settlement.CurrentSettlement.Town.FoodStocks
```

Max granary amount:

``` cs
Settlement.CurrentSettlement.Town.FoodStocksUpperLimit()
```

## Town

### TradeBoundVillages

    Settlement.Town.TradeBoundVillages

## Village

### GetItemPrice

``` cs
int GetItemPrice(ItemObject item, MobileParty tradingParty = null, bool isSelling = false)
    return this.TradeBound.Town.MarketData.GetPrice(itemRosterElement, tradingParty, isSelling, null);
```

### VillageState

- Normal
- BeingRaided
- ForcedForVolunteers
- ForcedForSupplies
- Looted (same as .IsDeserted)

### TradeBound

Returns Town to which the Village is trade bound.

### Levels

Village has 3 visual levels. Level depends on hearths: 

* Lvl 1 - hearths 1..199
* Lvl 2 - 200-599
* Lvl 3 - 600+


## XML

To be able to change the owner of the settlement in your mod, you need such files:

- settlements.xml
- settlements.xslt
- CUSTOM_settlements.xml

settlements.xml - full if you are working with the Editor, because Editor requires this file and overwrites it with every map save

settlements.xslt - to delete settlements.xml

CUSTOM_settlements.xml - to apply your changes.


What is interesting/weird - if you change name in the settlements.xml - the name of the settlement is changed in the game. But if you change the owner - owner is not changed. Owner is only changed in CUSTOM_settlements.xml, where 'CUSTOM' can be anything.

??? info "SubModule.xml should include:"
    ```cs
        <XmlNode>
            <XmlName id="Settlements" path="settlements"/>
            <IncludedGameTypes>
                <GameType value = "Campaign"/>
                <GameType value = "CampaignStoryMode"/>
                <GameType value = "CustomGame"/>
                <GameType value = "EditorGame"/>
            </IncludedGameTypes>
        </XmlNode>


        <XmlNode>
            <XmlName id="Settlements" path="CUSTOM_settlements"/>
            <IncludedGameTypes>
                <GameType value = "Campaign"/>
                <GameType value = "CampaignStoryMode"/>
                <GameType value = "CustomGame"/>
                <GameType value = "EditorGame"/>
            </IncludedGameTypes>
        </XmlNode>
    ```

??? danger "Never make changes to the CUSTOM_settlements.xml"
    Make changes to the settlemens.xml, then make file copy to the CUSTOM_settlements.xml.
    Otherwise files will be different and Editor uses settlemens.xml and if you change something on the map, changes will go to settlements.xml, it's get deleted with xslt and your CUSTOM file will be used with mismatching map and you will get a crash.


## Settlements Distance Cache

!!! quote "If you add new settlements, or relocate existing ones, you will need to recalculate settlements_distance_cache.bin which the game uses to optimise AI path finding between different settlements."

!!! info "From my observation: when adding new settlements it's not necessary to recalculate it, game works as it is. It is necessary to recalculate at the end (when all settlements are added) for performance."

The game crashes if settlements.xml and settlements_distance_cache.bin are incompatible.

    settlements_distance_cache.bin

Editor does not generate it by default on map save.

If settlements_distance_cache.bin is missing:

- v1.2.6b - it is generated by the game, when game starts. Visible in the log.
- v1.2.7 - it is not generated by the game and needs to be manually generated from the Editor.

Can be regenerated with the Editor using [SettlementPositionScript](/editor/settlementpositionscript)

<br><br>
